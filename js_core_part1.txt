/* ===============================
   JS CORE – PART 1
   رفع الصور + بناء صفحات HTML + GitHub API
   =============================== */

/* التحقق من تسجيل الدخول */
(function() {
  const user = localStorage.getItem("loggedInUser");
  if (!user) {
    window.location.href = "login.html";
    return;
  }
  window.CURRENT_USER = user;
})();

/* إعدادات GitHub */
const GITHUB_OWNER   = "XSF3X";
const GITHUB_REPO    = "MOE-SF";
const GITHUB_BRANCH  = "main";
const GITHUB_PAGES_BASE = "https://xsf3x.github.io/MOE-SF";

/* القالب */
const PPTX_TEMPLATE_URL = "static/template_v2.pptx";

/* قائمة المعايير */
const CRITERIA = [
  { id: 1,  title: "المعيار الأول",      subtitle: "أداء الواجبات الوظيفية" },
  { id: 2,  title: "المعيار الثاني",     subtitle: "التفاعل مع المجتمع المهني" },
  { id: 3,  title: "المعيار الثالث",     subtitle: "التفاعل مع أولياء الأمور" },
  { id: 4,  title: "المعيار الرابع",     subtitle: "استراتيجيات التدريس" },
  { id: 5,  title: "المعيار الخامس",     subtitle: "تحسين نتائج المتعلمين" },
  { id: 6,  title: "المعيار السادس",     subtitle: "خطة التعلم" },
  { id: 7,  title: "المعيار السابع",     subtitle: "التقنيات التعليمية" },
  { id: 8,  title: "المعيار الثامن",     subtitle: "تهيئة البيئة التعليمية" },
  { id: 9,  title: "المعيار التاسع",     subtitle: "الإدارة الصفية" },
  { id:10,  title: "المعيار العاشر",     subtitle: "تحليل نتائج المتعلمين" },
  { id:11,  title: "المعيار الحادي عشر", subtitle: "تنوع أساليب التقويم" },
  { id:12,  title: "منجزات أخرى",        subtitle: "منجزات العام الدراسي" }
];

/* الحالة العامة */
const state = {
  pptxBuffer: null,
  criteriaFiles: {},
  albums: {},
  teacherName: "",
  githubToken: localStorage.getItem("githubToken") || ""
};

/* عناصر DOM */
const gridEl = document.getElementById("criteria-grid");
const globalStatusEl = document.getElementById("global-status");
const btnGenerate = document.getElementById("btn-generate");
const qrSection = document.getElementById("qr-section");
const qrGrid = document.getElementById("qr-grid");

/* تحديث حالة GitHub */
function updateGithubStatus() {
  const s = document.getElementById("github-status");
  if (!s) return;
  s.textContent = state.githubToken ? "GitHub Token مضبوط" : "لم يتم إعداد GitHub Token";
}

/* حفظ GitHub Token */
function saveGithubToken() {
  const val = document.getElementById("githubTokenInput").value.trim();
  if (!val) return alert("أدخل Token صالح.");
  state.githubToken = val;
  localStorage.setItem("githubToken", val);
  updateGithubStatus();
  closeGithubPopup();
}

/* Slug لاسم المعلم */
function slugifyTeacher(name) {
  return name.trim().replace(/\s+/g,"-").replace(/[^\w\u0600-\u06FF-]/g,"");
}

/* اسم ملف HTML للمعيار */
function buildHtmlFileName(teacherName, criterionId) {
  const slug = slugifyTeacher(teacherName) || "teacher";
  const idStr = String(criterionId).padStart(2,"0");
  return `albums/${slug}_c${idStr}.html`;
}

/* رابط GitHub Pages النهائي */
function buildHtmlPageUrl(path) {
  return `${GITHUB_PAGES_BASE}/${path}`;
}

/* تحويل ملف → DataURL */
function fileToDataURL(file) {
  return new Promise((resolve,reject)=>{
    const reader = new FileReader();
    reader.onload = e => resolve(e.target.result);
    reader.onerror= reject;
    reader.readAsDataURL(file);
  });
}

/* HTML للصفحة */
function buildCriterionHtml({ teacherName, criterion, images }) {
  const safeTeacher = teacherName;
  return `
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head><meta charset="UTF-8">
<title>${criterion.title} - ${safeTeacher}</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
 body{background:#020617;color:#fff;font-family:Cairo,sans-serif;margin:0;padding:15px}
 h1{margin-bottom:5px;font-size:20px}
 .img-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:12px;margin-top:15px}
 .img-box{background:#0f172a;padding:8px;border-radius:10px;border:1px solid #334155}
 img{width:100%;border-radius:6px}
</style>
</head>
<body>
<h1>${criterion.title}</h1>
<div>${criterion.subtitle}</div>
<div>المعلم: ${safeTeacher}</div>
<div class="img-grid">
${images.map(x=>`<div class="img-box"><img src="${x}"></div>`).join("")}
</div>
</body>
</html>`;
}

/* رفع HTML إلى GitHub */
async function uploadFileToGitHub(path, content) {
  if (!state.githubToken) throw new Error("GitHub Token غير مضبوط.");

  const url = `https://api.github.com/repos/${GITHUB_OWNER}/${GITHUB_REPO}/contents/${encodeURIComponent(path)}`;
  const headers = {
    "Authorization": `Bearer ${state.githubToken}`,
    "Accept": "application/vnd.github+json"
  };

  let sha = null;
  const getRes = await fetch(url,{headers});
  if (getRes.ok) {
    const j = await getRes.json();
    sha = j.sha;
  }

  const body = {
    message:`update ${path}`,
    content: btoa(unescape(encodeURIComponent(content))),
    branch: GITHUB_BRANCH
  };
  if (sha) body.sha = sha;

  const putRes = await fetch(url,{
    method:"PUT",
    headers,
    body: JSON.stringify(body)
  });

  if (!putRes.ok) {
    const txt = await putRes.text();
    throw new Error(`Upload error: ${txt}`);
  }
}

/* تحميل قالب PPTX */
async function loadTemplate() {
  try {
    const res = await fetch(PPTX_TEMPLATE_URL);
    if (!res.ok) throw new Error("خطأ تحميل القالب");
    state.pptxBuffer = await res.arrayBuffer();
    globalStatusEl.textContent = "القالب جاهز — ارفع الصور ثم اضغط توليد الملف.";
  } catch (e) {
    globalStatusEl.textContent = "تعذر تحميل القالب.";
  }
}

/* بناء البطاقات */
function buildCards() {
  CRITERIA.forEach(c=>{
    const card = document.createElement("div");
    card.className = "card";
    card.dataset.criterionId = c.id;

    const header = document.createElement("div");
    header.className = "card-header";
    header.innerHTML = `<div class="card-title">${c.title}</div>
                        <div id="count-${c.id}" class="card-count">0 صورة</div>`;

    const subtitleEl = document.createElement("div");
    subtitleEl.className = "card-subtitle";
    subtitleEl.textContent = c.subtitle;

    const fileInput = document.createElement("input");
    fileInput.type="file";
    fileInput.multiple=true;
    fileInput.accept="image/*";
    fileInput.className="file-input";
    fileInput.id=`files-${c.id}`;

    const btn = document.createElement("button");
    btn.type="button";
    btn.className="btn btn-ghost";
    btn.textContent="اختيار صور الشواهد";
    btn.onclick=()=>fileInput.click();

    const status = document.createElement("div");
    status.className="card-status";
    status.id=`status-${c.id}`;
    status.textContent="لم يتم اختيار أي صورة.";

    fileInput.onchange=()=>{
      const files=[...fileInput.files];
      state.criteriaFiles[c.id]=files;
      document.getElementById(`count-${c.id}`).textContent=`${files.length} صورة`;
      status.textContent = files.length>0 ?
        "سيتم إنشاء صفحة HTML ورفعها." :
        "لم يتم اختيار أي صورة.";
    };

    const actions=document.createElement("div");
    actions.className="card-actions";
    actions.appendChild(btn);

    card.appendChild(header);
    card.appendChild(subtitleEl);
    card.appendChild(actions);
    card.appendChild(status);
    card.appendChild(fileInput);
    gridEl.appendChild(card);
  });
}

document.addEventListener("DOMContentLoaded", () => {
  updateGithubStatus();
  buildCards();
  loadTemplate();
});
